/*
 * This script explains how to perform token transfer intent when the okto auth token is available
 */

import { toHex } from "viem";
import { v4 as uuidv4 } from "uuid";
import { Constants } from "../helper/constants.js";
import { paymasterData } from "../utils/generatePaymasterData.js";
import {
  signUserOp,
  executeUserOp,
  type SessionConfig,
} from "../utils/invokeExecuteUserOp.js";
import { estimateUserOp } from "../utils/invokeEstimateUserOp.js";
import { getChains } from "../explorer/getChains.js";
import { getOrderHistory } from "../utils/getOrderHistory.js";

import dotenv from "dotenv";
import type { Address } from "../helper/types.js";

dotenv.config();
const OktoAuthToken = process.env.OKTO_AUTH_TOKEN as string;

interface Data {
  caipId: string;
  recipient: string;
  token: string;
  amount: string;
}

/**
 * Creates, estimates and executes a user operation for token transfer.
 *
 * This function initiates the process of transferring a token by encoding the necessary parameters into a User Operation.
 * For more information, check https://docs.okto.tech/docs/openapi/tokenTransfer
 *
 * @param data - The parameters for transferring the token (caip2Id, recipientWalletAddress, tokenAddress, amount)
 * @param sessionConfig - The sessionConfig object containing user SWA and session keys.
 * @returns The job ID for the token transfer.
 */
export async function transferToken(
  data: Data,
  sessionConfig: SessionConfig,
  feePayerAddress?: Address
) {
  // Generate a unique UUID based nonce
  const nonce = uuidv4();

  // get the Chain CAIP2ID required for payload construction
  // Note: Only the chains enabled on the Client's Developer Dashboard will be shown in the response
  const chains = await getChains(OktoAuthToken);
  console.log("Chains: ", chains);
  // Sample Response:
  //   Chains:  [
  //   {
  //     caip_id: 'eip155:8453',
  //     network_name: 'BASE',
  //     chain_id: '8453',
  //     logo: 'BASE',
  //     sponsorship_enabled: false,
  //     gsn_enabled: false,
  //     type: 'EVM',
  //     network_id: '9400de12-efc6-3e69-ab02-0eaf5aaf21e5',
  //     onramp_enabled: false,
  //     whitelisted: true
  //   },
  //   {
  //     caip_id: 'solana:EtWTRABZaYq6iMfeYKouRu166VU2xqa1',
  //     network_name: 'SOLANA_DEVNET',
  //     chain_id: '103',
  //     logo: 'SOL DEVNET',
  //     sponsorship_enabled: false,
  //     gsn_enabled: false,
  //     type: 'SVM',
  //     network_id: 'fb10a9ca-d197-378d-8fb3-fd95345571f3',
  //     onramp_enabled: false,
  //     whitelisted: true
  //   },
  //   {
  //     caip_id: 'eip155:84532',
  //     network_name: 'BASE_TESTNET',
  //     chain_id: '84532',
  //     logo: 'BASE_TESTNET',
  //     sponsorship_enabled: false,
  //     gsn_enabled: false,
  //     type: 'EVM',
  //     network_id: '8970cafe-4fc2-3a71-a7d3-77a672b749e9',
  //     onramp_enabled: false,
  //     whitelisted: true
  //   }
  // ]

  const currentChain = chains.find(
    (chain: any) => chain.caip_id === data.caipId
  );
  if (!currentChain) {
    throw new Error(`Chain Not Supported`);
  }

  // create the Estimate UserOp payload for token transfer intent
  console.log("generating estimateUserOp Payload...");
  let estimateUserOpPayload;

  if (feePayerAddress) {
    estimateUserOpPayload = {
      type: "TOKEN_TRANSFER",
      jobId: nonce,
      /*
       * Provide a field named feePayerAddress in estimateUserOpPayload if sponsorship is enabled.
       */
      feePayerAddress: feePayerAddress,
      paymasterData: await paymasterData({
        nonce,
        validUntil: new Date(Date.now() + 6 * Constants.HOURS_IN_MS),
      }),
      gasDetails: {
        maxFeePerGas: toHex(Constants.GAS_LIMITS.MAX_FEE_PER_GAS),
        maxPriorityFeePerGas: toHex(
          Constants.GAS_LIMITS.MAX_PRIORITY_FEE_PER_GAS
        ),
      },
      details: {
        recipientWalletAddress: data.recipient,
        caip2Id: data.caipId,
        tokenAddress: data.token,
        amount: data.amount,
      },
    };
  } else {
    estimateUserOpPayload = {
      type: "TOKEN_TRANSFER",
      jobId: nonce,
      /*
       * Do not provide a field named feePayerAddress in estimateUserOpPayload if sponsorship is not enabled.
       */
      paymasterData: await paymasterData({
        nonce,
        validUntil: new Date(Date.now() + 6 * Constants.HOURS_IN_MS),
      }),
      gasDetails: {
        maxFeePerGas: toHex(Constants.GAS_LIMITS.MAX_FEE_PER_GAS),
        maxPriorityFeePerGas: toHex(
          Constants.GAS_LIMITS.MAX_PRIORITY_FEE_PER_GAS
        ),
      },
      details: {
        recipientWalletAddress: data.recipient,
        caip2Id: data.caipId,
        tokenAddress: data.token,
        amount: data.amount,
      },
    };
  }

  // Sample Payload: {
  //     "type": "TOKEN_TRANSFER",
  //     "jobId": "92ba01db-4476-4e4d-9289-270429478121",
  //     "feePayerAddress": "0xdb9B5bbf015047D84417df078c8F06fDb6D71b76",
  //     "paymasterData": "0x0000000000000000000000000430e673e084367ba371e0653f28cda1bfb57db4000000000000000000000000000000000000000000000000000000006d0db17b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000004193956eec47540e6579a093869d78bcd606220db7d4764812d012a095090d153772533ab5d4394f7adbf60d3421e7c2aa7c5c92e0a57e3ca22e79803c9e7c71961c00000000000000000000000000000000000000000000000000000000000000",
  //     "gasDetails": {
  //         "maxFeePerGas": "0xBA43B7400",
  //         "maxPriorityFeePerGas": "0xBA43B7400"
  //     },
  //     "details": {
  //         "recipientWalletAddress": "0x15000a9E47E8527a7C4A02189e581F4D0Df589C3",
  //         "caip2Id": "eip155:137",
  //         "tokenAddress": "0xc2132d05d31c914a87c6611c10748aeb04b58e8f",
  //         "amount": "1"
  //     }
  // }

  // Call the estimateUserOp API to get the UserOp object
  console.log("calling estimate userop...");
  const estimateUserOpResponse = await estimateUserOp(
    estimateUserOpPayload,
    OktoAuthToken
  );
  console.log("estimateUserOpResponse:", estimateUserOpResponse);

  // Sample Response:
  //   estimateUserOpResponse:  {
  //     "jsonrpc": "2.0",
  //     "id": "a3db5fb9-f6de-4361-ac98-61978c2de962",
  //     "result": {
  //         "details": {
  //              estimation: {
  //              "amount": '1000000000000',
  //              "routeId": '',
  //              "sameChainFee": '',
  //              "sameChainFeeCollector": '',
  //              "crossChainFee": '',
  //              "crossChainFeeCollector": '',
  //              "recommendedSlippage": '',
  //              "slippageUsed": '',
  //              "outputAmount": '',
  //              "routeValidUntil": '',
  //              "totalFeesInInputToken": '',
  //              "platformBaseFeesInInputToken": '',
  //              "gasFeesInInputToken": '',
  //              "integratorFeesInInputToken": ''
  //             },
  //            "fees": {
  //              "transactionFees": { 'eip155:84532': '650999000000' },
  //              "approxTransactionFeesInUSDT": ''
  //            },
  //            "swapFees": {
  //              "totalFeesInInputToken": '',
  //              "platformBaseFeesInInputToken": '',
  //              "gasFeesInInputToken": '',
  //              "integratorFeesInInputToken": ''
  //            }
  //         },
  //         "callData": {
  //             "intentType": "TOKEN_TRANSFER",
  //             "jobId": "94cf4dde-4fb6-43fa-9f63-e444f857955a",
  //             "clientSWA": "0x6b6Fad2600Bc57075ee560A6fdF362FfefB9dC3C",
  //             "userSWA": "0xE14A85291F6A8DE60dC06b2dD373DfFDa779AF8D",
  //             "feePayerAddress": "0xdb9B5bbf015047D84417df078c8F06fDb6D71b76",
  //             "policies": {
  //                 "gsnEnabled": false,
  //                 "sponsorshipEnabled": false
  //             },
  //             "gsn": {
  //                 "isPossible": false,
  //                 "isRequired": false,
  //                 "requiredNetworks": [],
  //                 "tokens": []
  //             },
  //             "payload": {
  //                 "amount": "292",
  //                 "networkId": "eip155:137",
  //                 "recipientWalletAddress": "0x4FB6c27e0b862360219F70EB490c99E2328652fe",
  //                 "tokenAddress": "0xc2132D05D31c914a87C6611C10748AEb04B58e8F"
  //             }
  //         },
  //         "userOps": {
  //             "sender": "0xe14a85291f6a8de60dc06b2dd373dffda779af8d",
  //             "nonce": "0x0000000000000000000000000000000094cf4dde4fb643fa9f63e444f857955a",
  //             "callData": "0x8dd7712f00000000000000000000000000000000000000000000000000000000000000000000000000000000ed8fe2543efff64fc3567b03b612aa82c409579a000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000004248fa61ac00000000000000000000000000000000094cf4dde4fb643fa9f63e444f857955a0000000000000000000000006b6fad2600bc57075ee560a6fdf362ffefb9dc3c000000000000000000000000e14a85291f6a8de60dc06b2dd373dffda779af8d00000000000000000000000000000000000000000000000000000000000000e00000000000000000000000000000000000000000000000000000000000000140000000000000000000000000000000000000000000000000000000000000022000000000000000000000000000000000000000000000000000000000000003e000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001a00000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000124000000000000000000000000000000000000000000000000000000000000000a6569703135353a31333700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002a30783446423663323765306238363233363032313946373045423439306339394532333238363532666500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002a30786332313332443035443331633931346138374336363131433130373438414562303442353865384600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e544f4b454e5f5452414e5346455200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
  //             "callGasLimit": "0x484f6",
  //             "verificationGasLimit": "0x16c6c",
  //             "preVerificationGas": "0x1550d",
  //             "maxFeePerGas": "0xBA43B7400",
  //             "maxPriorityFeePerGas": "0xBA43B7400",
  //             "paymaster": "0x9b34131837d534cd199c0b8fdd8347c05e21a2d8",
  //             "paymasterVerificationGasLimit": "0x5489",
  //             "paymasterPostOpGasLimit": "0x1",
  //             "paymasterData": "0x0000000000000000000000006b6fad2600bc57075ee560a6fdf362ffefb9dc3c000000000000000000000000000000000000000000000000000000006d0db17b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000004154068cf6e7a8500235b3f765aeda6354d6979bcbc4243a09122a54184dec9fef07566cd973f27533eac066a53733bc722216d9af5c139847e99e3b3303ebfcf11c00000000000000000000000000000000000000000000000000000000000000"
  //         }
  //     }
  // }

  // Get the UserOp from the estimate response fetched above, sign it and add the signature to the userOp
  const userOp = estimateUserOpResponse.data?.userOps;
  console.log("UserOp: ", userOp);
  // Sample Response:
  //   UserOp:  {
  //   sender: '0x8b20023fc47d8f8bdb7418722dbb0e3e9964a906',
  //   nonce: '0x0000000000000000000000000000000004be9f24e9094ef59d6e81c7fa00e955',
  //   callData: '0x8dd7712f000000000000000000000000000000000000000000000000000000000000000000000000000000000543ad80b41c5f5956d34503668cdb965decb617000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000404bf7b90d70000000000000000000000000000000004be9f24e9094ef59d6e81c7fa00e95500000000000000000000000085dc8f5108b634c5c9bbd86fb8cea5ba570413890000000000000000000000008b20023fc47d8f8bdb7418722dbb0e3e9964a906000000000000000000000000db9b5bbf015047d84417df078c8f06fdb6d71b7600000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000024000000000000000000000000000000000000000000000000000000000000003c000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000e8d4a51000000000000000000000000000000000000000000000000000000000000000000c6569703135353a38343533320000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002a307838386265453865623639314646414642313932424143344431453730343265316234346333654632000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e544f4b454e5f5452414e5346455200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000',
  //   callGasLimit: '0x5faf2',
  //   verificationGasLimit: '0x28428',
  //   preVerificationGas: '0x1541f',
  //   maxFeePerGas: '0x77359400',
  //   maxPriorityFeePerGas: '0x77359400',
  //   paymaster: '0x74324fa6fa67b833dfdea4c1b3a9898574d076e3',
  //   paymasterVerificationGasLimit: '0x139a2',
  //   paymasterPostOpGasLimit: '0x1',
  //   paymasterData: '0x00000000000000000000000085dc8f5108b634c5c9bbd86fb8cea5ba5704138900000000000000000000000000000000000000000000000000000000681b899f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000041f12bc30483be47129e9cf4e769cab891fb3cef4d73e94bb3b25442fd5062a4447a5b4bfe1694ca59083ed4b309c0e0a2da968f028f4ad75f819d71951cfc3f341c00000000000000000000000000000000000000000000000000000000000000'
  // }

  const signedUserOp = await signUserOp(userOp, sessionConfig);
  console.log("Signed UserOp: ", signedUserOp);
  // Sample Response:
  // signed UserOp: {
  //   sender: '0x8b20023fc47d8f8bdb7418722dbb0e3e9964a906',
  //   nonce: '0x0000000000000000000000000000000004be9f24e9094ef59d6e81c7fa00e955',
  //   callData: '0x8dd7712f000000000000000000000000000000000000000000000000000000000000000000000000000000000543ad80b41c5f5956d34503668cdb965decb617000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000404bf7b90d70000000000000000000000000000000004be9f24e9094ef59d6e81c7fa00e95500000000000000000000000085dc8f5108b634c5c9bbd86fb8cea5ba570413890000000000000000000000008b20023fc47d8f8bdb7418722dbb0e3e9964a906000000000000000000000000db9b5bbf015047d84417df078c8f06fdb6d71b7600000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000024000000000000000000000000000000000000000000000000000000000000003c000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000e8d4a51000000000000000000000000000000000000000000000000000000000000000000c6569703135353a38343533320000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002a307838386265453865623639314646414642313932424143344431453730343265316234346333654632000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e544f4b454e5f5452414e5346455200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000',
  //   callGasLimit: '0x5faf2',
  //   verificationGasLimit: '0x28428',
  //   preVerificationGas: '0x1541f',
  //   maxFeePerGas: '0x77359400',
  //   maxPriorityFeePerGas: '0x77359400',
  //   paymaster: '0x74324fa6fa67b833dfdea4c1b3a9898574d076e3',
  //   paymasterVerificationGasLimit: '0x139a2',
  //   paymasterPostOpGasLimit: '0x1',
  //   paymasterData: '0x00000000000000000000000085dc8f5108b634c5c9bbd86fb8cea5ba5704138900000000000000000000000000000000000000000000000000000000681b899f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000041f12bc30483be47129e9cf4e769cab891fb3cef4d73e94bb3b25442fd5062a4447a5b4bfe1694ca59083ed4b309c0e0a2da968f028f4ad75f819d71951cfc3f341c00000000000000000000000000000000000000000000000000000000000000',
  //   signature: '0xba10ecbb4f36a4305ff5b4855276c058c4a2ad2d6ade4f7847929113dba6c7f168ebe11ba6c2c0079781470251246134fdde85096edee42fe23f096faefb252a1b'
  // }

  // Execute the userOp
  const jobId = await executeUserOp(signedUserOp, OktoAuthToken);
  console.log("Job ID:", jobId);
  // Sample Response:
  // jobId: a0a54427-11c8-4140-bfcc-e96af15ce9cf

  // Check the status of the jobId and get the transaction details
  const txn_details = await getOrderHistory(
    OktoAuthToken,
    jobId,
    "TOKEN_TRANSFER"
  );
  console.log("Order Details:", JSON.stringify(txn_details, null, 2));
}

// To get the caipId, please check: https://docsv2.okto.tech/docs/openapi/technical-reference
const data: Data = {
  caipId: "eip155:84532", // BASE_TESTNET
  recipient: "0x88beE8eb691FFAFB192BAC4D1E7042e1b44c3eF2", // Sample recipient on BASE_TESTNET
  token: "", // Left empty because transferring native token
  amount: "10000000000000", // denomination in lowest decimal (18 for WETH)
};

const sessionConfig: SessionConfig = {
  sessionPrivKey:
    "0x85ffef45e363f107476800f052102a940fcfa1167023ee462a859d3cada0cc76",
  sessionPubkey:
    "0x04869dbfba722c6d3bdcb56ac2475f37c85b21907b3c1f748271a80bca12d60ea45612dfdf7dfbdea0035ee8633d8c6717cea87ee451830bf0ecb35c6b37825e4c",
  userSWA: "0x281FaF4F242234c7AeD53530014766E845AC1E90",
};

/*
 * FeePayerAddress is the PaymasterSWA, which can be retrieved from the okto Developer dashboard - dashboard.okto.tech;
 * The gas fee will be deducted from the sponsor wallet; the sponsor wallet must be enabled and funded on the source chain on the txn you are performing.
 * Do not provide a field named feePayerAddress in estimateUserOpPayload if sponsorship is not enabled.
 */
const feePayerAddress: Address = "0xdb9B5bbf015047D84417df078c8F06fDb6D71b76";

/* if sponsorship is not enabled */
transferToken(data, sessionConfig);

/* if sponsorship is enabled */
transferToken(data, sessionConfig, feePayerAddress);
